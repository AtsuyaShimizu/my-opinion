# バックエンド詳細ドキュメント

## 1. 技術スタックと構成
- **Next.js API Routes (App Router)** をバックエンドとして使用します。
- APIは `src/app/api` 配下に集約され、ファイルパスがそのままエンドポイントに対応します。
- データストアは Supabase (PostgreSQL) を使用し、RLSでアクセス制御を行います。

## 2. APIルート構成
主なAPI領域は以下の通りです。

- **認証**: `/api/auth/*`
  - ログイン、サインアップ、ログアウト、パスワード更新
- **投稿**: `/api/posts/*`
  - 投稿作成、取得、削除、返信、リポスト、リアクション、分析
- **タイムライン**: `/api/timeline/*`
  - ホーム/探索/テーマ別の一覧
- **ユーザー**: `/api/users/*`
  - プロフィール取得、フォロー/フォロワー、属性更新
- **通知**: `/api/notifications/*`
  - 通知一覧、未読数、既読化
- **テーマ**: `/api/themes/*`
  - テーマ一覧、詳細
- **招待**: `/api/invite/*`
  - 招待コードの生成・検証・利用
- **通報**: `/api/reports`
  - 通報作成
- **管理**: `/api/admin/*`
  - ユーザー管理、テーマ管理、通報管理、統計
- **同意**: `/api/consent/*`
  - 同意記録の取得・登録・削除

## 3. Supabaseクライアントの使い分け
- `src/lib/supabase/server.ts`
  - `createServerClient()` を使用してRLS適用下でアクセス。
  - すべての通常APIで利用されます。
- `src/lib/supabase/service.ts`
  - サービスロールキーを使用し、RLSをバイパスする特権クライアント。
  - 通知生成や管理者処理など、権限が必要なケースで使用。

## 4. 認証・認可
- 各APIは `supabase.auth.getUser()` でログインユーザーを取得し、
  認証済みであることを前提に処理します。
- 管理者専用APIは RLS の `is_admin()` 関数によってDB側でも保護されます。

## 5. エラーハンドリング
- APIは `data` / `error` のJSONレスポンスを返す設計です。
- クライアント側の `apiFetch()` が共通のエラー処理を行います。

## 6. 代表的な処理フロー

### 6.1 投稿作成
1. クライアントが `/api/posts` にPOST。
2. APIで認証ユーザー取得。
3. `posts` テーブルにINSERT。
4. テーマ投稿であれば `theme_posts` を追加。

### 6.2 通知生成
1. 通知作成が必要なAPIでサービスロールクライアントを利用。
2. `notifications` テーブルにINSERT。
3. クライアント側で `/api/notifications` から取得。

### 6.3 管理者操作
1. 管理者が `/api/admin/*` を実行。
2. DB側RLSで `is_admin()` 判定を通過した場合のみ処理。
3. `admin_actions` にログ記録。

---

本ドキュメントは、バックエンドAPIの構成とSupabaseの利用方式を理解しやすくするために作成しています。
